<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Describes how authentication works inside Azure Cloud Shell"><title>Azure Cloud Shell, az login, and Managed Identity</title>
<link rel=canonical href=https://www.bathysphere.org/p/cloud-shell-auth/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Azure Cloud Shell, az login, and Managed Identity"><meta property='og:description' content="Describes how authentication works inside Azure Cloud Shell"><meta property='og:url' content='https://www.bathysphere.org/p/cloud-shell-auth/'><meta property='og:site_name' content='Bathysphere.org'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Azure'><meta property='article:tag' content='CloudShell'><meta property='article:published_time' content='2021-03-19T00:00:00+00:00'><meta property='article:modified_time' content='2021-03-19T00:00:00+00:00'><meta property='og:image' content='https://www.bathysphere.org/p/cloud-shell-auth/agenda.png'><meta name=twitter:title content="Azure Cloud Shell, az login, and Managed Identity"><meta name=twitter:description content="Describes how authentication works inside Azure Cloud Shell"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.bathysphere.org/p/cloud-shell-auth/agenda.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/pumpking_xs_hu_bd62e3b8dade0638.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Bathysphere.org</a></h1><h2 class=site-description>Don't take life so serious, it ain't nohow permanent</h2></div></header><ol class=menu-social><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.threads.net/@edyoung0 target=_blank title=Threads rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#oauth>OAuth</a></li><li><a href=#managed-identity>Managed Identity</a></li><li><a href=#managed-identity-in-cloud-shell>Managed Identity in Cloud Shell</a></li><li><a href=#tool-considerations>Tool Considerations</a></li><li><a href=#limitations-and-issues>Limitations and Issues</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/cloud-shell-auth/><img src=/p/cloud-shell-auth/agenda_hu_f7f65582f4df867c.png srcset="/p/cloud-shell-auth/agenda_hu_f7f65582f4df867c.png 800w, /p/cloud-shell-auth/agenda_hu_31d480c598d40268.png 1600w" width=800 height=500 loading=lazy alt="Featured image of post Azure Cloud Shell, az login, and Managed Identity"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/cloud-shell-auth/>Azure Cloud Shell, az login, and Managed Identity</a></h2><h3 class=article-subtitle>Describes how authentication works inside Azure Cloud Shell</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 19, 2021</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>When you open Azure Cloud Shell and run <code>Get-AzVM</code> or <code>az vm list</code> for the first time, it works right away. But why?</p><p>That may seem like an odd question. Of course it should work right away! But it doesn&rsquo;t work quite the same way when you run PowerShell or Azure CLI locally - you need to run <code>Connect-AzAccount</code> or <code>az login</code> first. So what&rsquo;s the difference?</p><p>A surprising amount of things are happening behind the scenes for this to work, and at the time of writing there are some limitations you might hit. This post tries to explain what is going on. If you just want to use Cloud Shell you don&rsquo;t really need to know any of this.</p><h2 id=oauth>OAuth</h2><p>Within Azure, basically everything is authenticated using <strong>OAuth</strong>. That&rsquo;s a complicated beast I can&rsquo;t explain here in detail. The docs <a class=link href=https://docs.microsoft.com/en-us/azure/active-directory/develop/authentication-vs-authorization target=_blank rel=noopener>here</a> provide a reasonable starting point. For our purposes, the important thing is that you authenticate yourself first to Azure Active Directory when you open the Azure Portal. AAD checks your password/PIN+smart card/whatever and issues a <strong>refresh token</strong>. This gets stored outside our scope in the browser - Cloud Shell never accesses it directly.</p><p>When you need to access a particular resource, you need an <strong>access token</strong>. Given the refresh token, you ask AAD &lsquo;hey, I want to access Azure Storage, can I have a token?&rsquo;. AAD then sends you a short-lived token (usually lasting 1 hour) which can then be presented to Azure Storage; storage checks the signature on the token and uses that to check if you are legit.</p><p>But as I mentioned, in Cloud Shell we don&rsquo;t have your refresh token, so how does this work?</p><h2 id=managed-identity>Managed Identity</h2><p><strong>Managed Identity</strong> is a cool scheme invented so that code which needs to access a resource doesn&rsquo;t need to store (and worry about the security and rotation of) a password. The Azure fabric manages an identity and is configured so that any code that runs on a particular VM can ask an endpoint &ldquo;Can I have an access token?&rdquo;. I think of this as an ambient credential for the VM - we grant that machine access to resources and allow code running on it to get tokens without any extra hassle.</p><p>This works by having a special endpoint. If you&rsquo;re on an Azure VM with a managed identity, you can run</p><p><code>curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F' -H Metadata:true</code></p><p>and get a token, which is just a JSON blob looking a bit like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;accessToken&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJ0blah...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expiresOn&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-03-19 23:12:01.371124&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;subscription&#34;</span><span class=p>:</span> <span class=s2>&#34;b1071e00-5da5-49c8-b902-14951e12f37a&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tenant&#34;</span><span class=p>:</span> <span class=s2>&#34;72f988bf-86f1-41af-91ab-2d7cd011db47&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tokenType&#34;</span><span class=p>:</span> <span class=s2>&#34;Bearer&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=managed-identity-in-cloud-shell>Managed Identity in Cloud Shell</h2><p>In Cloud Shell you still want an &lsquo;ambient&rsquo; identity - you don&rsquo;t want to sign on <em>again</em>. But you don&rsquo;t want a token that identifies you as the machine where Cloud Shell runs, you want one based on your own identity that you signed on to the portal with.</p><p>So we provide an alternative managed identity endpoint.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl <span class=s1>&#39;http://localhost:50342/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F&#39;</span> -H Metadata:true
</span></span></code></pre></td></tr></table></div></div><p>Will give you an access token based on your own identity. Unlike Azure&rsquo;s regular managed identity endpoint, this is implemented as another process running inside your container.
When it gets a request, it actually sends the request back to your browser, which forwards it to the parent Portal frame, which makes a request to AAD, and the resulting token
flows back down the same path.</p><h2 id=tool-considerations>Tool Considerations</h2><p>Client tools deal with this endpoint in different ways.</p><p>Azure PowerShell supports <code>Connect-AzAccount -Identity</code> which tells it to use managed identity (whether Cloud Shell or regular); AZ CLI has <code>az login --identity</code> for the same purpose. We run both during the Cloud Shell startup so you don&rsquo;t have to.</p><p>You can also login explicitly, by running <code>az login</code> or <code>Connect-AzAccount</code>. That overrides this mechanism and can be used to (for example) use a different identity than the one you logged on to Cloud Shell with.</p><h2 id=limitations-and-issues>Limitations and Issues</h2><p>This works great most of the time, but there are a couple of snags you might run into.</p><ol><li><p>We have an allow-list of resources that we can provide tokens for (a limitation we hope to raise in future). This means that when someone introduces a brand new resource type for a new service, we have to update the list in Cloud Shell too. If you run a command and see something like this: <code>"error":{"code":"AudienceNotSupported","message":"Audience https://coolnewservice.azure.com/ is not a supported MSI token audience...."}"</code> you have hit this issue. Please feel free to file an issue at <a class=link href=https://github.com/Azure/CloudShell/issues target=_blank rel=noopener>https://github.com/Azure/CloudShell/issues</a> and we&rsquo;ll endeavor to add it as soon as we can.</p></li><li><p>If you login explicitly (<code>az login</code>) any Conditional Access rules your company may have in place will be evaluated based on the Cloud Shell container rather than the machine where your browser runs. The Cloud Shell container doesn&rsquo;t count as a managed device for these policies so rights may be limited by the policy.</p></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/azure/>Azure</a>
<a href=/tags/cloudshell/>CloudShell</a></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Mar 19, 2021 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/how-azure-cloud-shell-stores-your-files/><div class=article-image><img src=/p/how-azure-cloud-shell-stores-your-files/csfiles.6329bd42e363d4adb431bf70b6126091_hu_4a3ff9e7830700d9.png width=250 height=150 loading=lazy alt="Featured image of post How Azure Cloud Shell stores your files" data-hash="md5-Yym9QuNj1K20Mb9wthJgkQ=="></div><div class=article-details><h2 class=article-title>How Azure Cloud Shell stores your files</h2></div></a></article><article class=has-image><a href=/p/cloud-shell-installs/><div class=article-image><img src=/p/cloud-shell-installs/image.86d0656c95f65c095a182d1515f30cf4_hu_a0a413aea785ba54.png width=250 height=150 loading=lazy alt="Featured image of post How to install your own versions of tools in Azure Cloud Shell" data-key=cloud-shell-installs data-hash="md5-htBlbJX2XAlaGC0VFfMM9A=="></div><div class=article-details><h2 class=article-title>How to install your own versions of tools in Azure Cloud Shell</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Bathysphere.org</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>