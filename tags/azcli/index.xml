<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azcli on Bathysphere.org</title><link>https://www.bathysphere.org/tags/azcli/</link><description>Recent content in Azcli on Bathysphere.org</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 22 Sep 2020 17:11:06 -0700</lastBuildDate><atom:link href="https://www.bathysphere.org/tags/azcli/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure Arc command-line tools cheat sheet</title><link>https://www.bathysphere.org/p/azurearc-cheatsheet/</link><pubDate>Tue, 22 Sep 2020 17:11:06 -0700</pubDate><guid>https://www.bathysphere.org/p/azurearc-cheatsheet/</guid><description>&lt;img src="https://www.bathysphere.org/p/azurearc-cheatsheet/orbiter.jpg" alt="Featured image of post Azure Arc command-line tools cheat sheet" />&lt;p>Arc for Servers has an Azure CLI extension and PowerShell module. Because they are prerelease, they are not included (yet) in the main releases
(ie, you don&amp;rsquo;t get this just by installing az cli or the Az module).
However they are already functional and useful. Here&amp;rsquo;s how to do some simple operations with each of them.&lt;/p>
&lt;h2 id="install">Install
&lt;/h2>&lt;p>AZ CLI:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">az extension add connectedmachine
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Azure PowerShell:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Install-Module&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Az&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ConnectedMachine&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="list-machines">List machines
&lt;/h2>&lt;p>AZ CLI&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">az connectedmachine list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># only display a few properties in a convenient form&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">az connectedmachine list --query &lt;span class="s2">&amp;#34;[].{Name:name,ResourceGroup:resourceGroup,Location:location,Status:status}&amp;#34;&lt;/span> -o table
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Azure PowerShell:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-AzConnectedMachine&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="list-extensions-installed-on-a-machine">List extensions installed on a machine
&lt;/h2>&lt;p>AZ CLI&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">az connectedmachine extension list --resource-group edyoung --machine-name edwin-virtual-machine
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Azure PowerShell:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-AzConnectedMachineExtension&lt;/span> &lt;span class="n">-ResourceGroupName&lt;/span> &lt;span class="n">edyoung&lt;/span> &lt;span class="n">-MachineName&lt;/span> &lt;span class="nb">edwin-virtual&lt;/span>&lt;span class="n">-machine&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="install-custom-script-extension-on-a-windows-machine-and-run-dir">Install Custom Script Extension on a windows machine and run &amp;lsquo;dir&amp;rsquo;
&lt;/h2>&lt;p>Note that installing extensions currently takes several minutes. Please be patient.&lt;/p>
&lt;p>AZ CLI run in bash&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Note --location needs to be the location of the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">az connectedmachine extension create --machine-name silverbox-ne --resource-group edyoung --name myext --type &lt;span class="s2">&amp;#34;CustomScriptExtension&amp;#34;&lt;/span> --publisher &lt;span class="s2">&amp;#34;Microsoft.Compute&amp;#34;&lt;/span> --settings &lt;span class="s1">&amp;#39;{&amp;#34;commandToExecute&amp;#34;:&amp;#34;dir&amp;#34;}&amp;#39;&lt;/span> --location &lt;span class="s2">&amp;#34;North Europe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>AZ CLI run inside PowerShell (the escaping is different for settings param)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">az&lt;/span> &lt;span class="n">connectedmachine&lt;/span> &lt;span class="n">extension&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-machine-name&lt;/span> &lt;span class="nb">silverbox-ne&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-resource-group&lt;/span> &lt;span class="n">edyoung&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-name&lt;/span> &lt;span class="n">myext&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-type&lt;/span> &lt;span class="s2">&amp;#34;CustomScriptExtension&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-publisher&lt;/span> &lt;span class="s2">&amp;#34;Microsoft.Compute&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-settings&lt;/span> &lt;span class="s1">&amp;#39;{\&amp;#34;commandToExecute\&amp;#34;:\&amp;#34;dir\&amp;#34;}&amp;#39;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-location&lt;/span> &lt;span class="s2">&amp;#34;North Europe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Azure PowerShell&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">New-AzConnectedMachineExtension&lt;/span> &lt;span class="n">-MachineName&lt;/span> &lt;span class="nb">silverbox-ne&lt;/span> &lt;span class="n">-ResourceGroupName&lt;/span> &lt;span class="n">edyoung&lt;/span> &lt;span class="n">-Location&lt;/span> &lt;span class="s2">&amp;#34;North Europe&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">myext&lt;/span> &lt;span class="n">-Setting&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#34;commandToExecute&amp;#34;:&amp;#34;dir&amp;#34;}&amp;#39;&lt;/span> &lt;span class="n">-ExtensionType&lt;/span> &lt;span class="n">CustomScriptExtension&lt;/span> &lt;span class="n">-Publisher&lt;/span> &lt;span class="n">Microsoft&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Compute&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="delete-an-extension">Delete an extension
&lt;/h2>&lt;p>AZ CLI&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">az connectedmachine extension delete --name myext -g edyoung --machine-name silverbox-ne
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Azure PowerShell&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Remove-AzConnectedMachineExtension&lt;/span> &lt;span class="n">-MachineName&lt;/span> &lt;span class="nb">silverbox-ne&lt;/span> &lt;span class="n">-ResourceGroupName&lt;/span> &lt;span class="n">edyoung&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">myext&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>What's the difference between az account show and Get-AzContext?</title><link>https://www.bathysphere.org/p/whats-the-difference-between-az-account-show-and-get-azcontext/</link><pubDate>Mon, 07 Sep 2020 17:11:06 -0700</pubDate><guid>https://www.bathysphere.org/p/whats-the-difference-between-az-account-show-and-get-azcontext/</guid><description>&lt;img src="https://www.bathysphere.org/p/whats-the-difference-between-az-account-show-and-get-azcontext/paris.jpg" alt="Featured image of post What's the difference between az account show and Get-AzContext?" />&lt;p>One issue which can trip you up when using command-line tools to configure Azure is a confusing &lt;em>lack&lt;/em> of interaction between Azure CLI and Azure PowerShell. They both provide a &amp;ldquo;context&amp;rdquo; so you don&amp;rsquo;t have to keep specifying the subscription over and over. But Azure CLI (the &lt;code>az&lt;/code> command) has a separate context from Azure PowerShell. You can see this by running&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">az account show &lt;span class="c1"># show azure CLI context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Get-AzContext &lt;span class="c1"># show azure Powershell context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">az account &lt;span class="nb">set&lt;/span> --subscription &lt;span class="s1">&amp;#39;mysub2&amp;#39;&lt;/span> &lt;span class="c1"># change Azure CLI context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">az account show &lt;span class="c1"># azure CLI has changed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Get-AzContext &lt;span class="c1"># Azure PowerShell has not!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>You should find that the second output from &lt;code>az account show&lt;/code> has changed to your &lt;code>mysub2&lt;/code> subscription, but &lt;code>Get-AzContext&lt;/code> still has the previous value. Similarly, you can run &lt;code>Set-AzContext -Subscription xxx&lt;/code> and it will change the output from &lt;code>Get-AzContext&lt;/code> but not the output from &lt;code>az account show&lt;/code>.&lt;/p>
&lt;p>So if you have a script where you change Azure CLI&amp;rsquo;s context and then you run an Azure PowerShell command, it looks at PowerShell&amp;rsquo;s context (which hasn&amp;rsquo;t changed) so it doesn&amp;rsquo;t produce the answer you want.&lt;/p>
&lt;p>You can fix this by either: run &lt;code>Set-AzContext&lt;/code> as well before running the cmdlet; or running the az equivalent of your cmdlet, which will honor the az context.&lt;/p>
&lt;p>You may be thinking &amp;ldquo;That&amp;rsquo;s crazy! Why do it that way? You should change it so both share a context!&amp;rdquo; I don&amp;rsquo;t personally know the history of why these 2 are separate. But to be honest I doubt that it can be changed at this point without causing a lot of backward-compatibility issues for people who accidentally or deliberately rely on the current behavior.&lt;/p></description></item></channel></rss>