[{"content":"Limited systems can be cheaper and better Writing a robust, general-purpose system is often quite expensive. For example, the memory allocator behind malloc() and new is the result of years of work and fine-tuning. It has to handle every weird allocation pattern, be completely thread-safe on 64-core processors, minimize memory fragmentation and overhead, etc. If the memory allocator is inadequate for some reason and you feel the urge to write your own replacement, a starting assumption is that it will take you about as long as the original took - maybe quicker if you are very smart, longer if you are unfamiliar with the problem space. In many cases that\u0026rsquo;s impractical.\nHowever if you introduce the right limitation it can massively reduce the effort required. malloc is partly complicated because the caller can allocate and deallocate any sized chunk of memory in any order, from any thread. An arena allocator has a different interface: the caller first creates an arena, then allocates many small chunks of memory inside that arena, then deletes the arena when complete, invalidating and freeing all the small chunks at once. This works well if you need to allocate a number of temporary structures to process a request, then can dispose them all at the end. Usually the implementation is a big chunk of memory and a next pointer. To allocate memory, just return the current value of next and increment it by the number of bytes requested. The implementation can be a few hundred lines, and allocation will be very fast.\nWhy is this cheaper to implement? Because we\u0026rsquo;ve embraced a limitation and produced a less general interface. The limitation here is on free() - the caller can\u0026rsquo;t free individual memory chunks. That doesn\u0026rsquo;t seem like a huge difference, but it simplifies things a lot.\nBuy general-purpose, build special-purpose It rarely makes sense to write your own very general-purpose subsystem (like custom programming language, database engine, memory allocator) if your main goal is to build an application - you likely can\u0026rsquo;t afford to do a good job of it.\nBut if the off-the-shelf components are not suitable, it may make sense to solve a specialized subset of the problem: not a programming language but a tiny DSL; not a general-purpose allocator but an arena allocator. You can take advantage of the limitations you have embraced to simplify the implementation by orders of magnitude.\nDon\u0026rsquo;t evolve your special-purpose system to make it more general So you successfully implemented your special-purpose DSL for mangling your custom data. Maybe it\u0026rsquo;s super fast and reliable because it has no looping constructs or branches so execution time is bounded. Everyone loves it. But then someone comes along and says \u0026ldquo;but you know, it would be really nice if we could do a loop here\u0026hellip;\u0026rdquo;. If you go ahead and kludge in a wonky looping construct, this is a classic blunder, like going up against a Sicilian when death is on the line. Now your system has lost its defining limitation, it is competing against general-purpose languages, and on those metrics it probably sucks - limited adoption, no debugger, no standard library, no ecosystem, and so on.\nThis blunder is so classic it has its own Wikipedia article. Don\u0026rsquo;t fall for it! Either stick with your limited system and embrace the limitations, or if the problem really is more general, you have to suck it up and adopt the \u0026lsquo;real\u0026rsquo; system.\n","date":"2025-05-08T00:00:00Z","image":"https://www.bathysphere.org/p/embrace-limitations/image_hu_f3f5d552fd78adbd.png","permalink":"https://www.bathysphere.org/p/embrace-limitations/","title":"Embrace Limitations"},{"content":"Some computer systems are obviously safety-critical. If you are working on flight-control software for Boeing or Airbus, everyone involved is aware that mistakes in this program could cause loss of life. So software like this is written very, very carefully - extremely detailed specifications, often proofs of correctness using a theorem prover, exhaustive testing, and so on.\nBut there are also cases where general-purpose software can wind up in a situation where bugs could cause dangerous consequences. I\u0026rsquo;m using \u0026ldquo;unofficial safety-critical software\u0026rdquo; quite loosely to refer to refer to this.\nFor example, a web search turns up many resources like https://www.snprs.scot.nhs.uk/?page_id=635, which contains an Excel spreadsheet for calculating drug dosages, including for dangerous medications like fentanyl. If there are errors either in the Excel application itself, or in the spreadsheet, it doesn\u0026rsquo;t seem like a stretch to say that could kill a child. It\u0026rsquo;s not surprising that the web page says \u0026ldquo;Disclaimer: this drug calculator is intended as an aid to management and must AT ALL TIMES be used in conjunction with local drug preparation, checking and administration policies\u0026rdquo;\nI don\u0026rsquo;t mean by this to call out either the people who made this calculator, or Microsoft, as having done something wrong. I don\u0026rsquo;t have any firm conclusions at all, but likely this is a lot safer than calculating things by hand.\nBut it raises some interesting questions.\nIs Excel \u0026ldquo;unofficial safety-critical software\u0026rdquo;? Is the spreadsheet itself USCC? How about any sufficiently-powerful program, like a programming language or MATLAB, which could be used for life-or-death calculations? If calculating dosages in a spreadsheet is too dangerous, what would we recommend instead? How do we distribute responsibility for correctness between Excel, the spreadsheet author, and the physician using the spreadsheet? Excel\u0026rsquo;s EULA and the web page disclaimer push the responsibility entirely to the end user. Is that reasonable? Is the software I work on unofficially safety-critical? Should that change my approach? ","date":"2025-03-30T00:00:00Z","image":"https://www.bathysphere.org/p/unofficial-safety/safety_hu_5313c9bc5ec537dc.jpg","permalink":"https://www.bathysphere.org/p/unofficial-safety/","title":"Unofficial Safety-Critical Software"},{"content":"There\u0026rsquo;s a lot of discussion about Technical Debt in Software Engineering. I believe the term originated on the C2 wiki. It\u0026rsquo;s often used to explain to non-software-engineers why it\u0026rsquo;s important to invest in code quality.\nI\u0026rsquo;m far from the first person to think that the term Technical Debt is potentially misleading. Rob Jeffries has a discussion here.\nTo oversimplify, debt involves interest payments. These compound over time, occur at predictable intervals, can be paid off, and cost a fairly predictable amount of money. None of these are true when you decide to take shortcuts in software: the passage of time has no direct compounding effect, and you don\u0026rsquo;t know when the bill will come due or how expensive it will be.\nThis mismatch between the term and the implications can be a problem if it conveys the wrong impression to our non-software colleague.\nI like the term deferred maintenance better. This is also an inexact metaphor but I think it\u0026rsquo;s closer. Anyone who has owned a car understands that it needs maintenance. If you don\u0026rsquo;t change the oil at regular intervals, the car will gradually run more slowly and roughly. Eventually, at an upredictable time, the engine will seize up and you\u0026rsquo;ll be faced with a large and unpredictable bill to replace the entire thing. If you don\u0026rsquo;t service the brakes, the results can be significantly worse. Consider a 747 instead of a Corolla if you really want to emphasize the importance of maintenance.\nYou can extend this notion to help justify the idea of scheduling time explicitly for maintenance activity, like a monthly or quarterly \u0026rsquo;tune-up'.\nBottom line: if you have a large piece of software which is not maintained, you own a very complicated machine which is not performing as well as it could, and might break down at any point.\n","date":"2022-04-24T00:00:00Z","image":"https://www.bathysphere.org/p/deferred-maintenance/image_hu_29a1d3ff607b51e0.png","permalink":"https://www.bathysphere.org/p/deferred-maintenance/","title":"Deferred Maintenance is a better metaphor than Technical Debt"},{"content":"Financial Perpetual Motion Every so often, someone claims to have created a perpetual motion machine, or a source of free energy - some kind of contraption which does work without any external power source. Anyone with a physics background knows that this is impossible due to the laws of thermodynamics, but these claims still find a small credulous audience. Normally the device is accompanied by lots of handwaving to obscure the fact that it can\u0026rsquo;t possibly work.\nI\u0026rsquo;ve recently noticed a number of crypto projects which are IMHO \u0026lsquo;Financial Perpetual Motion Machines\u0026rsquo;. They claim to produce free money, without any form of actual revenue. Perhaps because the laws of finance are not quite as clear-cut or widely understood as thermodynamics, these projects have gained more attention from speculators than they deserve.\nThis is my attempt to explain why these projects are Financial Perpetual Motion Machines (FPMMs), using Titano as an example. There are many others like Wonderland or Safuu (which offers 383,000% interest!).\nWhat is Titano? Titano says it is \u0026ldquo;The Best Auto-Staking \u0026amp; Auto-Compounding Protocol in Crypto\u0026rdquo;, and advertises an eye-catching \u0026ldquo;102,483% APY\u0026rdquo;. You buy some Titano tokens, and like a bank they pay you interest - you get more tokens each day (in fact, every 30 minutes) that you continue to hold them. Unlike a bank, you get 100,000% interest, instead of about 1% for a savings account. This is so much interest that if you start with $1,000 of Titano and hold it for one year, you wind up with over $1,000,000. 😲 This sounds pretty good! Unfortunately, it is too good to be true, as we will see.\nCompound interest Our first red flag is just to do the math for a few years. Let\u0026rsquo;s imagine you buy 1000 tokens and hold.\nYear Tokens 0 1,000 1 1,024,830 2 1,050,276,000 3 1,076,354,895,000 In other words, you can be a token trillionaire in 3 short years! Does that sound plausible?\nLoans and interest More generally, say you have a great idea for a business, but no money right now. You can borrow money, and then when your great idea makes a profit, pay it back. This is the foundation of capitalism. However the person who lends you the money is taking a risk - maybe your idea isn\u0026rsquo;t so hot after all - so they want interest. You have to pay back more than you borrowed. Lots of factors affect the interest rate, but risk is probably the biggest. This is why, unfairly enough, if you have a high credit rating and can pay back your credit card easily you get a lower rate than someone with a bad credit rating. If you have really bad credit you might only be able to get a predatory payday loan, which can have interest rates as high as 400% to 700% APR.\nLet\u0026rsquo;s apply this to Titano. If we regard Titano as a business venture, by purchasing tokens you are making them a loan, and they are paying you interest on it. Surprisingly they are willing to pay interest over 100 times higher than a payday loan. This is our second red flag. Why would a borrower pay interest higher than they need to? I assume you would shop around for the best rate before taking out a mortgage. Are Titano offering this rate out of the kindness of their hearts, or because lending money to pseudonymous cryptobros without any kind of security is extremely risky?\nRevenue Assuming you are an honest business, your business plan must factor in making enough money to pay back the loans, including interest. If you have to pay 100% interest, any venture which makes less than 100% return over the same period is going to be a loss for you. Applying this to Titano, how do they make money?\nThe only current source of revenue is a cut whenever someone buys or sells Titano. This is red flag #3, and to my mind the real reason to regard this as financial perpetual motion. A real venture needs to make money: for example, by lending money to others, like a bank does, or by making cars and selling them. Titano only makes money as a side-effect of people speculating on Titano. There is a road map but it doesn\u0026rsquo;t look like a business plan which actually makes any money, let alone 100,000% ROI. It\u0026rsquo;s worth recalling that no business in human history has produced that kind of return.\nExchange rates and inflation In the above discussion I assume that 1 Titano token has a constant price measured in \u0026lsquo;real terms\u0026rsquo;. (Feel free to quibble about how real the USD or the Euro are, if you like). This isn\u0026rsquo;t true, of course. You can regard Titano as a foreign currency with a floating exchange rate vs USD.\nThere is a way for Titano to pay 100,000% interest denominated in Titano without a corresponding 100,000% increase in the value of the underlying venture: inflation. This is the approach taken by economic powerhouses such as Zimbabwe and Weimar-era Germany. If the supply of Titano increases 1000x but the value of Titano the project remains static, you could expect the value of each token to drop by 1000x.\nConclusion To assess the plausibility of a perpetual motion machine, it\u0026rsquo;s easiest to go back to first principles: where does the energy come from? If there\u0026rsquo;s no clear explanation, it\u0026rsquo;s baloney.\nTo decide whether a financial \u0026lsquo;innovation\u0026rsquo; like Titano is a legitimate venture or a FPMM, it\u0026rsquo;s easiest to go back to first principles: where does the money come from? If there\u0026rsquo;s no clear explanation, this quickly makes it apparent there is nothing there. You can ignore all the waffle about treasuries, burns and risk-free value.\nEpilog Unspurprisingly, Titano shut down less than a year after this was written.\n","date":"2022-03-26T00:00:00Z","image":"https://www.bathysphere.org/p/financial-perpetual-motion/image_hu_8d6a3737c23d2061.png","permalink":"https://www.bathysphere.org/p/financial-perpetual-motion/","title":"Financial Perpetual Motion"},{"content":"Disclaimer: I\u0026rsquo;m not an expert on the crypto space, just a curious amateur. It\u0026rsquo;s quite possible I have misunderstood something important below. Do let me know of any corrections via the comment section!\nIf you read the Ethereum website on DAO\u0026rsquo;s, you\u0026rsquo;ll see this:\nDAOs are an effective and safe way to work with like-minded folks around the globe.\nThink of them like an internet-native business that\u0026rsquo;s collectively owned and managed by its members. They have built-in treasuries that no one has the authority to access without the approval of the group. Decisions are governed by proposals and voting to ensure everyone in the organization has a voice.\nThere\u0026rsquo;s no CEO who can authorize spending based on their own whims and no chance of a dodgy CFO manipulating the books. Everything is out in the open and the rules around spending are baked into the DAO via its code.\nThis is not really true for most DAOs. I\u0026rsquo;ll explain.\nI will use \u0026lsquo;The Spice DAO\u0026rsquo; (aka Dune DAO) as an example, since that\u0026rsquo;s been in the news lately. This DAO was originally set up with the stated goal of purchasing a copy of the \u0026lsquo;pitch book\u0026rsquo; Alejandro Jodorowsky put together while trying to persuade Hollywood studios to fund a movie he wanted to make based on Frank Herbert\u0026rsquo;s novel Dune. They succeeded in raising a substantial amount of money - approximately $12M dollars. They were then able to purchase the book at auction, but then had to work out what to do with the rest of the money. I think the fight that ensued over the proper fate of the funds encapsulates a lot of the issues around DAO governance.\nThe contract It is true that there\u0026rsquo;s no official CEO or CFO for a DAO. But that doesn\u0026rsquo;t mean there isn\u0026rsquo;t an inner circle of people who hold the true power. In a DAO, these are the people who know the private keys to the DAO\u0026rsquo;s wallet. For the Dune DAO these are\n1 2 3 4 5 6 7 Spice DAO\u0026#39;s funds will be held in a 3/5 Gnosis Multi-sig of the following team: @Yojimbo_King (Remilia Collective) @Sobylife (Ex Populus) @CharlieFang77 (Remilia Collective) @DeezeFi (Fractional Art) @DrydenwtBrown (Praxis Society) source\nThis means that the DAO can only transfer funds if 3 out of 5 of these people agree to do so by signing the transaction. (Incidentally, it would be entirely possible to create a DAO where all of the signing keys are held by the same real-world individual via multiple separate wallets, thus giving the illusion of a \u0026lsquo;board\u0026rsquo; where none exists. I\u0026rsquo;m not alleging that is the case for the Spice DAO, just that in general it is possible to do so, and quite hard for someone else to detect.)\nWhat limitations are there on what the signers can do, as long as 3 of them agree to do it? Can they spend all the money on fine wines and yachts? Well, they can do whatever the smart contract allows them to. Ethereum allows \u0026lsquo;smart contracts\u0026rsquo; - snippets of code which enforce rules, mostly about how cryptographic transactions occur. So you might hope from the Ethereum website\u0026rsquo;s description that \u0026ldquo;There\u0026rsquo;s no CEO who can authorize spending on their own whims\u0026rdquo; is enforced by a smart contract.\nFor Spice DAO, and I believe the vast majority of DAOs, this is not the case. The \u0026lsquo;smart contract\u0026rsquo; can be found here. It\u0026rsquo;s rather difficult to audit because there\u0026rsquo;s no verified source code for this contract, just a bunch of Ethereum bytecode. If it\u0026rsquo;s not obvious to you what a page of hex digits starting with \u0026lsquo;0x608060405234801561001057600080fd5b50600436106101515760003560e01c8063715018a61\u0026hellip;\u0026rsquo; means, you\u0026rsquo;re not alone. Fortunately the Etherscan.io website comes with a decompiler which can convert it to something semi-readable.\nI\u0026rsquo;m not an expert in deciphering these contracts (and I definitely wouldn\u0026rsquo;t be able to spot a well-disguised malicious contract), but as far as I can see it\u0026rsquo;s just a wallet. In particular there\u0026rsquo;s no encoded limitations on what the wallet holders can do (such as limits on transaction size or counterparties). So my claim is that in practice, \u0026lsquo;3 out of 5 wallet holders can authorize spending based on their own whims\u0026rsquo;.\n\u0026ldquo;But wait!\u0026rdquo; I hear you say. What about governance tokens? Don\u0026rsquo;t those control the DAO?\nGlad you asked.\nGovernance Tokens and Proposals When you fund a DAO, you are typically given tokens in return - in the case of the Spice DAO, these are called $SPICE. These can be bought and sold, and each such token gives you one vote on any governance proposal. If a majority of tokens vote in favor of the proposal, it is passed. The Spice DAO page says \u0026ldquo;Proposals will be executed on-chain by the multisig.\u0026rdquo; which sounds important. Power to the people!\nWell, sort of.\nThe Spice DAO has had one governance proposal so far, the text of which can be seen here: https://snapshot.org/#/dunedao.eth/proposal/0x2038fc240d0e85c496cc692d0001fb159d6f613b546392aa96e49a3b752ced0d . This was held after the initial auction. It\u0026rsquo;s interesting to me that during the most important times in the DAO\u0026rsquo;s existence - the initial fundraising and the purchase of the book - there was actually no formal governance of the DAO beyond the mission statement on the fundraising page. In fact, the book was actually purchased by @sobylife using his own money, and the DAO reimbursed him.\nThe proposal formalizes who can do what, and how much money they can spend, eg.\nOperations Budget\nAs Treasurer, Charlie will have autonomy in using funds to cover monthly operational expenses such as core team compensation and third-party independent contractor invoices with a monthly discretionary budget of 50,000 USDC:\nCore team compensation = Maximum 31,665.60 USDC/month\nThird-party contractors such as IT, social media agency, book shipping and storage and software developers, and unforeseen incidentals = Maximum 18,334.40 USDC/month\nThe governance proposal was passed with little fuss and 95.97% of votes in favor. It was \u0026rsquo;executed on chain\u0026rsquo; by creating a block with a link to an IPFS file containing the English text of the proposal. But it\u0026rsquo;s important to note a couple of things.\nThe governance proposal is just English, not code. It has no technical effect on the smart contract or what the DAO signature holders can actually do. It\u0026rsquo;s a little unclear whether it constitutes a legally binding contract either. I Am Not A Lawyer, but I don\u0026rsquo;t believe it\u0026rsquo;s well-settled law whether a DAO token owner can sue anyone for not abiding by the terms in the governance proposal. So these governance proposals are purely advisory, and they\u0026rsquo;re almost certainly toothless if the signature holders don\u0026rsquo;t want to play ball. Also also:\nWho gets to decide if a governance proposal even comes up for a vote? Why the signature holders of course. If you have a proposal they don\u0026rsquo;t like, nobody will ever get to vote on it. In this case, over 50% of the votes were cast by a single individual. I suspect whales will determine the outcome of any proposal vote in practice. Conclusions Many DAOs are neither decentralized (power belongs to the signers and somewhat to major token holders), autonomous (most smart contracts are anything but) nor particularly organized. They are essentially wallets with a handful of signers and a manifesto. You might want to bear this in mind when choosing whether to invest. There are definitely some projects which are trying more complex approaches (see https://medium.com/compound-finance/building-a-governance-interface-474fc271588c) but you should not assume that any given DAO uses these.\n","date":"2022-01-21T00:00:00Z","image":"https://www.bathysphere.org/p/dao-hype/image_hu_d6a6a779803cb84c.png","permalink":"https://www.bathysphere.org/p/dao-hype/","title":"DAOn't believe the hype"},{"content":"The official information on Cloud Shell\u0026rsquo;s file storage is here. It\u0026rsquo;s good stuff, and covers most things you might like to know, take a look! This blog contains a few more behind-the-scenes details for the curious. NB: We might change this in the future, this isn\u0026rsquo;t guaranteed.\nWe can see from the docs that all your files are stored in an Azure File Share which belongs to you, and which you select when you first start CLoud Shell. But how do those files map to the directory layout you see in Cloud Shell?\nYou can see that there are several mount points set up:\n1 2 3 4 5 6 7 8 9 10 11 12 edwin@Azure:~$ df -H Filesystem Size Used Avail Use% Mounted on overlay 52G 17G 36G 32% / tmpfs 68M 0 68M 0% /dev tmpfs 2.1G 0 2.1G 0% /sys/fs/cgroup /dev/sda1 52G 17G 36G 32% /home shm 68M 8.2k 68M 1% /dev/shm //csxxx.file.core.windows.net/cs-edyoung-microsoft-com-xxx 6.5G 5.4G 1.1G 84% /usr/csuser/clouddrive tmpfs 2.1G 0 2.1G 0% /proc/acpi tmpfs 2.1G 0 2.1G 0% /proc/scsi tmpfs 2.1G 0 2.1G 0% /sys/firmware /dev/loop0 5.3G 1.3G 3.7G 27% /home/edwin You can ignore the overlay and tmpfs stuff, which is container voodoo.\nThe bits that matter:\nInside Cloud Shell, you have a classic Unix filesystem. Under the filesystem root /, most everything is owned by root, and is not writable by the Cloud Shell user. This includes all the utility programs Cloud Shell ships. Even if you find some way to elevate privileges and update them, all the changes will be lost the next time you run Cloud Shell, because these are part of the container image, and are recreated every time you reconnect.\nThere\u0026rsquo;s also your \u0026lsquo;cloud drive\u0026rsquo;, which is your Azure File Share mounted as a CIFS filesystem as /usr/csuser/clouddrive. In this example, mine is in the file share cs-edyoung-microsoft-com-xxx in the storage account csxxx.file.core.windows.net There\u0026rsquo;s a symlink set up so that ~/clouddrive goes to the same location. Through that you can read and write files to the Azure file share.\nYour home directory is different. It\u0026rsquo;s under /home/username (mine is /home/edwin ) and is writable. You can see that is a mount point for /dev/loop0, which is a loopback filesystem. A loopback filesystem allows you to create a filesystem inside a file. Where is that file? Inside your cloud drive fileshare, as a regular file .cloudconsole/acc_username.img\n1 2 edwin@Azure:~$ ls -l ~/clouddrive/.cloudconsole/acc_edwin.img -rwxrwxrwx 1 edwin edwin 5368709120 May 26 06:25 /home/edwin/clouddrive/.cloudconsole/acc_edwin.img You can see this is a 5GB file. Inside that file is an entire filesystem, which contains the files which you have stored in your home directory. Don\u0026rsquo;t delete or modify that file, or you\u0026rsquo;ll lose whatever you have in your Cloud Shell home directory. Generally you should treat this file as opaque, but if you desperately want to you could download the file and mount it as a loopback device on a regular Linux box. If for some reason you want to delete everything in your home directory, you could delete that file from the file share, and when you restart Cloud Shell we will create a new home directory file for you.\nEphemeral Storage If you are using Cloud Shell in ephemeral mode, then your home directory is just part of the container image, and everything in it will disappear when your session ends.\n","date":"2021-05-25T00:00:00Z","image":"https://www.bathysphere.org/p/how-azure-cloud-shell-stores-your-files/csfiles_hu_c993c79d9fa1365.png","permalink":"https://www.bathysphere.org/p/how-azure-cloud-shell-stores-your-files/","title":"How Azure Cloud Shell stores your files"},{"content":"When you open Azure Cloud Shell and run Get-AzVM or az vm list for the first time, it works right away. But why?\nThat may seem like an odd question. Of course it should work right away! But it doesn\u0026rsquo;t work quite the same way when you run PowerShell or Azure CLI locally - you need to run Connect-AzAccount or az login first. So what\u0026rsquo;s the difference?\nA surprising amount of things are happening behind the scenes for this to work, and at the time of writing there are some limitations you might hit. This post tries to explain what is going on. If you just want to use Cloud Shell you don\u0026rsquo;t really need to know any of this.\nOAuth Within Azure, basically everything is authenticated using OAuth. That\u0026rsquo;s a complicated beast I can\u0026rsquo;t explain here in detail. The docs here provide a reasonable starting point. For our purposes, the important thing is that you authenticate yourself first to Azure Active Directory when you open the Azure Portal. AAD checks your password/PIN+smart card/whatever and issues a refresh token. This gets stored outside our scope in the browser - Cloud Shell never accesses it directly.\nWhen you need to access a particular resource, you need an access token. Given the refresh token, you ask AAD \u0026lsquo;hey, I want to access Azure Storage, can I have a token?\u0026rsquo;. AAD then sends you a short-lived token (usually lasting 1 hour) which can then be presented to Azure Storage; storage checks the signature on the token and uses that to check if you are legit.\nBut as I mentioned, in Cloud Shell we don\u0026rsquo;t have your refresh token, so how does this work?\nManaged Identity Managed Identity is a cool scheme invented so that code which needs to access a resource doesn\u0026rsquo;t need to store (and worry about the security and rotation of) a password. The Azure fabric manages an identity and is configured so that any code that runs on a particular VM can ask an endpoint \u0026ldquo;Can I have an access token?\u0026rdquo;. I think of this as an ambient credential for the VM - we grant that machine access to resources and allow code running on it to get tokens without any extra hassle.\nThis works by having a special endpoint. If you\u0026rsquo;re on an Azure VM with a managed identity, you can run\ncurl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\u0026amp;resource=https%3A%2F%2Fmanagement.azure.com%2F' -H Metadata:true\nand get a token, which is just a JSON blob looking a bit like this:\n1 2 3 4 5 6 7 { \u0026#34;accessToken\u0026#34;: \u0026#34;eyJ0blah...\u0026#34;, \u0026#34;expiresOn\u0026#34;: \u0026#34;2021-03-19 23:12:01.371124\u0026#34;, \u0026#34;subscription\u0026#34;: \u0026#34;b1071e00-5da5-49c8-b902-14951e12f37a\u0026#34;, \u0026#34;tenant\u0026#34;: \u0026#34;72f988bf-86f1-41af-91ab-2d7cd011db47\u0026#34;, \u0026#34;tokenType\u0026#34;: \u0026#34;Bearer\u0026#34; } Managed Identity in Cloud Shell In Cloud Shell you still want an \u0026lsquo;ambient\u0026rsquo; identity - you don\u0026rsquo;t want to sign on again. But you don\u0026rsquo;t want a token that identifies you as the machine where Cloud Shell runs, you want one based on your own identity that you signed on to the portal with.\nSo we provide an alternative managed identity endpoint.\n1 curl \u0026#39;http://localhost:50342/metadata/identity/oauth2/token?api-version=2018-02-01\u0026amp;resource=https%3A%2F%2Fmanagement.azure.com%2F\u0026#39; -H Metadata:true Will give you an access token based on your own identity. Unlike Azure\u0026rsquo;s regular managed identity endpoint, this is implemented as another process running inside your container. When it gets a request, it actually sends the request back to your browser, which forwards it to the parent Portal frame, which makes a request to AAD, and the resulting token flows back down the same path.\nTool Considerations Client tools deal with this endpoint in different ways.\nAzure PowerShell supports Connect-AzAccount -Identity which tells it to use managed identity (whether Cloud Shell or regular); AZ CLI has az login --identity for the same purpose. We run both during the Cloud Shell startup so you don\u0026rsquo;t have to.\nYou can also login explicitly, by running az login or Connect-AzAccount. That overrides this mechanism and can be used to (for example) use a different identity than the one you logged on to Cloud Shell with.\nLimitations and Issues This works great most of the time, but there are a couple of snags you might run into.\nWe have an allow-list of resources that we can provide tokens for (a limitation we hope to raise in future). This means that when someone introduces a brand new resource type for a new service, we have to update the list in Cloud Shell too. If you run a command and see something like this: \u0026quot;error\u0026quot;:{\u0026quot;code\u0026quot;:\u0026quot;AudienceNotSupported\u0026quot;,\u0026quot;message\u0026quot;:\u0026quot;Audience https://coolnewservice.azure.com/ is not a supported MSI token audience....\u0026quot;}\u0026quot; you have hit this issue. Please feel free to file an issue at https://github.com/Azure/CloudShell/issues and we\u0026rsquo;ll endeavor to add it as soon as we can.\nIf you login explicitly (az login) any Conditional Access rules your company may have in place will be evaluated based on the Cloud Shell container rather than the machine where your browser runs. The Cloud Shell container doesn\u0026rsquo;t count as a managed device for these policies so rights may be limited by the policy.\n","date":"2021-03-19T00:00:00Z","image":"https://www.bathysphere.org/p/cloud-shell-auth/agenda_hu_41392aafff3d65a5.png","permalink":"https://www.bathysphere.org/p/cloud-shell-auth/","title":"Azure Cloud Shell, az login, and Managed Identity"},{"content":"Arc for Servers has an Azure CLI extension and PowerShell module. Because they are prerelease, they are not included (yet) in the main releases (ie, you don\u0026rsquo;t get this just by installing az cli or the Az module). However they are already functional and useful. Here\u0026rsquo;s how to do some simple operations with each of them.\nInstall AZ CLI:\n1 az extension add connectedmachine Azure PowerShell:\n1 Install-Module -Name Az.ConnectedMachine List machines AZ CLI\n1 2 3 4 az connectedmachine list # only display a few properties in a convenient form az connectedmachine list --query \u0026#34;[].{Name:name,ResourceGroup:resourceGroup,Location:location,Status:status}\u0026#34; -o table Azure PowerShell:\n1 Get-AzConnectedMachine List extensions installed on a machine AZ CLI\n1 az connectedmachine extension list --resource-group edyoung --machine-name edwin-virtual-machine Azure PowerShell:\n1 Get-AzConnectedMachineExtension -ResourceGroupName edyoung -MachineName edwin-virtual-machine Install Custom Script Extension on a windows machine and run \u0026lsquo;dir\u0026rsquo; Note that installing extensions currently takes several minutes. Please be patient.\nAZ CLI run in bash\n1 2 # Note --location needs to be the location of the machine az connectedmachine extension create --machine-name silverbox-ne --resource-group edyoung --name myext --type \u0026#34;CustomScriptExtension\u0026#34; --publisher \u0026#34;Microsoft.Compute\u0026#34; --settings \u0026#39;{\u0026#34;commandToExecute\u0026#34;:\u0026#34;dir\u0026#34;}\u0026#39; --location \u0026#34;North Europe\u0026#34; AZ CLI run inside PowerShell (the escaping is different for settings param)\n1 az connectedmachine extension create --machine-name silverbox-ne --resource-group edyoung --name myext --type \u0026#34;CustomScriptExtension\u0026#34; --publisher \u0026#34;Microsoft.Compute\u0026#34; --settings \u0026#39;{\\\u0026#34;commandToExecute\\\u0026#34;:\\\u0026#34;dir\\\u0026#34;}\u0026#39; --location \u0026#34;North Europe\u0026#34; Azure PowerShell\n1 New-AzConnectedMachineExtension -MachineName silverbox-ne -ResourceGroupName edyoung -Location \u0026#34;North Europe\u0026#34; -Name myext -Setting \u0026#39;{\u0026#34;commandToExecute\u0026#34;:\u0026#34;dir\u0026#34;}\u0026#39; -ExtensionType CustomScriptExtension -Publisher Microsoft.Compute Delete an extension AZ CLI\n1 az connectedmachine extension delete --name myext -g edyoung --machine-name silverbox-ne Azure PowerShell\n1 Remove-AzConnectedMachineExtension -MachineName silverbox-ne -ResourceGroupName edyoung -Name myext ","date":"2020-09-22T17:11:06-07:00","image":"https://www.bathysphere.org/p/azurearc-cheatsheet/orbiter_hu_3527278df86fc561.jpg","permalink":"https://www.bathysphere.org/p/azurearc-cheatsheet/","title":"Azure Arc command-line tools cheat sheet"},{"content":"Cloud Shell comes with a lot of tools, and we try to keep them up to date. But sometimes you need something a little bit more cutting edge or unusual. How do you install it?\nUsing Cloud Shell is a little different from running your own Linux computer, but it\u0026rsquo;s a lot like using a multi-user Unix system. The main difference is you are not root and we won\u0026rsquo;t tell you the root password (sorry). So anything that requires you to run sudo or change files outside your home directory or /tmp won\u0026rsquo;t work. This includes old favorites like apt-get install.\nWhy? A tiny bit for security - we don\u0026rsquo;t want to make it any easier for people to break out of Cloud Shell than it needs to be - but mostly for consistency. In Cloud Shell the only things that persist across sessions are the contents of your home directory and clouddrive. If you manage to change files and install something under /usr/bin, it would magically be gone the next time you start Cloud Shell, and that wouldn\u0026rsquo;t be too helpful.\nSo the short version is, anything you can install to your home directory or below it will work just fine. Let\u0026rsquo;s look at some examples.\nPowerShell modules Just install them with Install-Module. By default, they will be saved to ~/.local/share/powershell/Modules/. Those will be loaded first in preference to ones that are installed in the system-wide directories, which can be good and bad. Mostly good, but consider this:\nCloud Shell ships with AwesomeModule 1.0 You\u0026rsquo;re like \u0026ldquo;That\u0026rsquo;s old school, AwesomeModule 1.1 is way better\u0026rdquo;. Install-Module AwesomeModule -RequiredVersion 1.1 FTW! Cloud Shell updates to AwesomeModule 2.0 You still wind up using AwesomeModule 1.1. Sadness. This can be particularly tricky with the Azure PowerShell modules, because installing one of them brings along 10 others it depends on. You may want to periodically delete ~/.local/share/powershell/Modules/ to be on the safe side.\nNode Modules Just install them with npm install. But npm install -g tries to update /usr/local/lib/node_modules which won\u0026rsquo;t work, so don\u0026rsquo;t do that.\nAZ CLI and extensions You can install AZ CLI extensions with az extension add. This saves the extension to a location in your home dir, and just works.\nHowever updating the whole of AZ CLI is more difficult. I don\u0026rsquo;t have good instructions for doing that at the moment.\nRandom Executables and tools If you have a favorite unix tool look for the \u0026ldquo;Manual Installation\u0026rdquo; instructions on its home page, those will usually work even if apt-get does not. For example, we don\u0026rsquo;t have the GitHub CLI tool (at the time of writing anyway😉). If you look at https://github.com/cli/cli/blob/trunk/docs/install_linux.md it starts with instructions about using apt-get which (sorry) won\u0026rsquo;t work. But under \u0026lsquo;Manual Instructions\u0026rsquo; it turns out you can just download https://github.com/cli/cli/releases/download/v1.0.0/gh_1.0.0_linux_amd64.tar.gz , unpack it and run it.\n1 2 3 wget https://github.com/cli/cli/releases/download/v1.0.0/gh_1.0.0_linux_amd64.tar.gz tar xzvf gh_1.0.0_linux_amd64.tar.gz gh_1.0.0_linux_amd64/bin/gh The last bit points out one snag. You either need to run a program via its full path or add it to a directory in your $PATH. As with PowerShell modules, be aware that if your directory is earlier in the $PATH than the standard ones, if you shadow a tool that Cloud Shell installs you might not see future updates.\nTerraform Terraform basically falls under the \u0026lsquo;random executables bucket\u0026rsquo; but there are a few special considerations.\nYou can install it locally with\n1 2 3 wget -O terraform.zip https://releases.hashicorp.com/terraform/0.13.2/terraform_0.13.2_linux_amd64.zip unzip terraform.zip ./terraform But it won\u0026rsquo;t behave quite the same as the one in Cloud Shell. That\u0026rsquo;s because if you look at\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 edwin@Azure:~$ more /usr/local/bin/terraform #!/usr/bin/env bash set -e export ARM_SUBSCRIPTION_ID=`az account show --output=json | jq -r -M \u0026#39;.id\u0026#39;` export ARM_TENANT_ID=`az account show --output=json | jq -r -M \u0026#39;.tenantId\u0026#39;` export ARM_MSI_ENDPOINT=$MSI_ENDPOINT if [ -z \u0026#34;$ARM_MSI_ENDPOINT\u0026#34; ]; then export ARM_USE_MSI=false else export ARM_USE_MSI=true fi export PATH=/usr/local/terraform:$PATH terraform \u0026#34;$@\u0026#34; You can see it\u0026rsquo;s really a script where we set a couple environment variables so terraform works better in Cloud Shell. To get the benefit of those too, you need to copy the script to (say) ~/terraform.sh and edit it so it finds and runs your local terraform executable as well.\n","date":"2020-09-21T18:11:06-07:00","image":"https://www.bathysphere.org/p/cloud-shell-installs/image_hu_d19f2cd0953fd985.png","permalink":"https://www.bathysphere.org/p/cloud-shell-installs/","title":"How to install your own versions of tools in Azure Cloud Shell"},{"content":"A few people have asked \u0026ldquo;Hey, uh, hypothetically, if I had typed a password or a secret at the Cloud Shell prompt, did you store it, and how would I delete it? Obviously I would never do this, asking for a friend.\u0026rdquo;\nRelax, we\u0026rsquo;ve all done it. And the answer is \u0026ldquo;Sort of\u0026rdquo;.\nIn more detail, Cloud Shell does not store your history itself. But the shell you are running inside it does, unless you have configured something specially. The details depend on the shell. Since the shell doesn\u0026rsquo;t know what is a password and what is not, it will store secrets if you type them directly at the command-line.\nBash Bash stores the commands you type in ~/.bash_history. This gets saved when you exit the shell.\nPowerShell PowerShell uses a package called PSReadLine to do the command-line interaction (such as tab completion). That module, rather than PowerShell itself, stores the commands you type in ~/.local/share/powershell/PSReadLine/ConsoleHost_history.txt by default. You can adjust the location and behavior with Set-PSReadLineOption.\nCleaning Up Whichever shell you use, you can clear either file by deleting it. Remember that the file is usually updated at the end of a session, so you may need to exit Cloud Shell, reopen it, then delete the file to be sure you caught it.\nYour entire home directory (including these files) is stored in a file called .cloudconsole/acc_{username}.img which is kept in your Cloud Drive, which is in your own Azure subscription. You can see this by clicking \u0026ldquo;Manage File Share\u0026rdquo; in the Cloud Shell toolbar and opening the .cloudconsole folder in Storage Explorer. If you are feeling super paranoid you can delete the whole file, but you will of course lose everything in your home directory.\n","date":"2020-09-07T18:11:06-07:00","image":"https://www.bathysphere.org/p/cloud-shell-history/image_hu_5c447808132a9adb.png","permalink":"https://www.bathysphere.org/p/cloud-shell-history/","title":"Does Azure Cloud Shell store my command history?"},{"content":"One issue which can trip you up when using command-line tools to configure Azure is a confusing lack of interaction between Azure CLI and Azure PowerShell. They both provide a \u0026ldquo;context\u0026rdquo; so you don\u0026rsquo;t have to keep specifying the subscription over and over. But Azure CLI (the az command) has a separate context from Azure PowerShell. You can see this by running\n1 2 3 4 5 az account show # show azure CLI context Get-AzContext # show azure Powershell context az account set --subscription \u0026#39;mysub2\u0026#39; # change Azure CLI context az account show # azure CLI has changed Get-AzContext # Azure PowerShell has not! You should find that the second output from az account show has changed to your mysub2 subscription, but Get-AzContext still has the previous value. Similarly, you can run Set-AzContext -Subscription xxx and it will change the output from Get-AzContext but not the output from az account show.\nSo if you have a script where you change Azure CLI\u0026rsquo;s context and then you run an Azure PowerShell command, it looks at PowerShell\u0026rsquo;s context (which hasn\u0026rsquo;t changed) so it doesn\u0026rsquo;t produce the answer you want.\nYou can fix this by either: run Set-AzContext as well before running the cmdlet; or running the az equivalent of your cmdlet, which will honor the az context.\nYou may be thinking \u0026ldquo;That\u0026rsquo;s crazy! Why do it that way? You should change it so both share a context!\u0026rdquo; I don\u0026rsquo;t personally know the history of why these 2 are separate. But to be honest I doubt that it can be changed at this point without causing a lot of backward-compatibility issues for people who accidentally or deliberately rely on the current behavior.\n","date":"2020-09-07T17:11:06-07:00","image":"https://www.bathysphere.org/p/whats-the-difference-between-az-account-show-and-get-azcontext/paris_hu_19e530d1c3b71111.jpg","permalink":"https://www.bathysphere.org/p/whats-the-difference-between-az-account-show-and-get-azcontext/","title":"What's the difference between az account show and Get-AzContext?"}]